<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>GÃ©nÃ©rateur de fiche NL</title>
<meta name="google-signin-client_id" content="639970630190-dbtusqa5kb93jdthsr3413ms7t235anl.apps.googleusercontent.com">

<link rel="stylesheet" href="styles.css?v=1.0.0">
</head>

<body>

<div class="container">
  <h1>ğŸ‡³ğŸ‡± GÃ©nÃ©rateur de fiche NL</h1>
  <p class="subtitle">CrÃ©ez des fiches de rÃ©vision en nÃ©erlandais en quelques clics</p>

  <!-- Login Container -->
  <div id="loginContainer" class="login-container">
    <div class="login-box">
      <h2>ğŸ” AccÃ¨s sÃ©curisÃ©</h2>
      <p>Connectez-vous avec votre compte Google</p>
      <div class="error-message" id="errorMessage">
        âŒ AccÃ¨s refusÃ©. Veuillez vÃ©rifier votre email.
      </div>
      <div class="google-signin-container">
        <div id="g_id_onload"
             data-client_id="639970630190-dbtusqa5kb93jdthsr3413ms7t235anl.apps.googleusercontent.com"
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard"></div>
      </div>
    </div>
  </div>

  <!-- User Info (affichÃ© aprÃ¨s connexion) -->
  <div class="user-info" id="userInfo">
    <p>ConnectÃ© en tant que : <strong id="userEmail"></strong></p>
  </div>

  <!-- Form Container -->
  <div id="formContainer">
    <div class="box">
      <h2>1. RÃ©gion</h2>
      <input type="text" id="region" placeholder="Ex : Nijmegen">
    </div>

    <div class="box">
      <h2>2. Date</h2>
      <input type="date" id="date">
    </div>

    <div class="box">
      <h2>3. Titre</h2>
      <input type="text" id="titre" placeholder="Titre de l'article">
    </div>

    <div class="box">
      <h2>4. Article</h2>
      <textarea id="article" placeholder="Colle ici l'article"></textarea>
      <h3>Image (upload)</h3>
      <input type="file" id="imageInput" accept="image/*">
    </div>

    <div class="box">
      <h2>5. Vocabulaire (CSV)</h2>
      <textarea id="csvVocab" placeholder="Colle ici ton CSV vocabulaire"></textarea>
    </div>

    <div class="box">
      <h2>6. Verbes (CSV)</h2>
      <textarea id="csvVerbes" placeholder="Colle ici ton CSV verbes"></textarea>
    </div>

    <div class="button-group">
      <button onclick="genererFiche()">âœ¨ GÃ©nÃ©rer la fiche HTML</button>
      <button class="secondary" onclick="seDeconnecter()">ğŸ”’ DÃ©connexion</button>
    </div>

    <h2 class="output-title">Code gÃ©nÃ©rÃ© :</h2>
    <textarea id="output"></textarea>

    <div class="button-group" style="margin-top: 20px;">
      <button id="btnTelecharger" class="secondary" onclick="telechargerFiche()" style="display:none;">â¬‡ï¸ TÃ©lÃ©charger</button>
    </div>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// ===== CONFIGURATION GOOGLE SIGN-IN =====
// Ã€ remplacer par votre CLIENT_ID depuis Google Cloud Console
const AUTHORIZED_EMAILS = [
  "darkmoulasse@gmail.com" // Ajoutez vos emails autorisÃ©s ici
];

function handleCredentialResponse(response) {
  // DÃ©coder le JWT token
  const base64Url = response.credential.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(
    atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join('')
  );
  
  const data = JSON.parse(jsonPayload);
  const userEmail = data.email;
  
  // VÃ©rifier si l'email est autorisÃ©
  if (AUTHORIZED_EMAILS.includes(userEmail)) {
    // Connexion rÃ©ussie
    sessionStorage.setItem('userEmail', userEmail);
    // Redirection vers admin.html
    window.location.href = 'admin.html';
  } else {
    // Email non autorisÃ©
    document.getElementById('errorMessage').classList.add('show-error');
    setTimeout(() => {
      location.reload();
    }, 2000);
  }
}

window.onload = function() {
  // VÃ©rifier si dÃ©jÃ  connectÃ©
  if (sessionStorage.getItem('userEmail')) {
    const email = sessionStorage.getItem('userEmail');
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('userInfo').style.display = 'block';
    document.getElementById('userEmail').textContent = email;
    document.getElementById('formContainer').style.display = 'block';
  }
};

// DÃ©connexion Google
function seDeconnecter() {
  if (confirm('ÃŠtes-vous sÃ»r de vouloir vous dÃ©connecter ?')) {
    google.accounts.id.disableAutoSelect();
    sessionStorage.removeItem('userEmail');
    document.getElementById('formContainer').style.display = 'none';
    document.getElementById('userInfo').style.display = 'none';
    document.getElementById('loginContainer').style.display = 'block';
    resetFormulaire();
    location.reload();
  }
}

// Initialiser le formulaire
function initialiserFormulaire() {
  document.getElementById("output").value = "";
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("date").value = today;
}

// RÃ©initialiser le formulaire
function resetFormulaire() {
  document.getElementById("region").value = '';
  document.getElementById("date").value = '';
  document.getElementById("titre").value = '';
  document.getElementById("article").value = '';
  document.getElementById("csvVocab").value = '';
  document.getElementById("csvVerbes").value = '';
  document.getElementById("output").value = '';
  document.getElementById('btnTelecharger').style.display = 'none';
  imageBase64 = '';
  htmlGenere = '';
}

let imageBase64 = "";
let htmlGenere = "";

// Convertir l'image uploadÃ©e en Base64
document.getElementById("imageInput").addEventListener("change", function() {
  const file = this.files[0];
  const reader = new FileReader();
  reader.onload = e => imageBase64 = e.target.result;
  reader.readAsDataURL(file);
});

// ===============================
//  PARSEUR CSV ROBUSTE
// ===============================
function parseCSV(text) {
  const rows = [];
  let current = "";
  let row = [];
  let insideQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const next = text[i + 1];

    if (c === '"' && insideQuotes && next === '"') {
      current += '"';
      i++;
    }
    else if (c === '"') {
      insideQuotes = !insideQuotes;
    }
    else if (c === ',' && !insideQuotes) {
      row.push(current.trim());
      current = "";
    }
    else if ((c === '\n' || c === '\r') && !insideQuotes) {
      if (current.length > 0 || row.length > 0) {
        row.push(current.trim());
        rows.push(row);
      }
      row = [];
      current = "";
    }
    else {
      current += c;
    }
  }

  if (current.length > 0 || row.length > 0) {
    row.push(current.trim());
    rows.push(row);
  }

  return rows;
}

// EmpÃªcher les caractÃ¨res dangereux
function escapeHTML(str = "") {
  return str
    .replace(/`/g, "\\`")
    .replace(/\${/g, "\\${");
}

function genererFiche() {
  const region = escapeHTML(document.getElementById("region").value.trim());
  const date = document.getElementById("date").value;
  const titre = escapeHTML(document.getElementById("titre").value.trim());
  const article = escapeHTML(document.getElementById("article").value.trim());
  const csvVocab = document.getElementById("csvVocab").value.trim();
  const csvVerbes = document.getElementById("csvVerbes").value.trim();

  if (!titre || !article || !date) {
    alert("Merci de remplir au minimum la rÃ©gion, la date, le titre et l'article.");
    return;
  }

  // Parsing CSV
  const vocabRows = parseCSV(csvVocab).slice(1);
  const verbRows = parseCSV(csvVerbes).slice(1);

  const vocabData = vocabRows.map(r => ({
    nl: escapeHTML(r[0] || ""),
    genre: escapeHTML(r[1] || ""),
    fr: escapeHTML(r[2] || ""),
    exemple: escapeHTML(r[3] || "")
  }));

  const verbData = verbRows.map(r => ({
    verbe: escapeHTML(r[0] || ""),
    type: escapeHTML(r[1] || ""),
    forme: escapeHTML(r[2] || ""),
    sens: escapeHTML(r[3] || ""),
    exemple: escapeHTML(r[4] || "")
  }));

  const questions = vocabData
    .map(v => ({ question: `Que signifie "${v.nl}" ?`, reponse: v.fr }))
    .sort(() => Math.random() - 0.5)
    .slice(0, 10);

  // GÃ©nÃ©ration HTML
  const vocabRows_html = vocabData.map(v => 
  '<tr><td><button onclick="pronounce(\'' + v.nl.replace(/'/g, "\\'") + '\')" style="background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 0; color: #4ecdc4;">ğŸ”Š</button> ' + v.nl + '</td><td>' + v.genre + '</td><td>' + v.fr + '</td><td>' + v.exemple + '</td></tr>'
).join('');

  const verbRows_html = verbData.map(v => 
  '<tr><td><button onclick="pronounce(\'' + v.verbe.replace(/'/g, "\\'") + '\')" style="background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 0; color: #4ecdc4;">ğŸ”Š</button> ' + v.verbe + '</td><td>' + v.type + '</td><td>' + v.forme + '</td><td>' + v.sens + '</td><td>' + v.exemple + '</td></tr>'
).join('');

  const questionsJSON = JSON.stringify(questions);
  const imageTag = imageBase64 ? '<img src="' + imageBase64 + '" style="max-width:300px; border-radius: 8px; margin: 15px 0;">' : '';

  htmlGenere = '<!DOCTYPE html>\n' +
'<html lang="fr">\n' +
'<head>\n' +
'<meta charset="UTF-8">\n' +
'<meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
'<title>' + titre + '</title>\n' +
'<link rel="stylesheet" href="styles.css">\n' +
'</head>\n' +
'<body>\n' +
'<div class="fiche-container">\n' +
'<div class="fiche-header">\n' +
'<h1 class="fiche-title">' + titre + '</h1>\n' +
'<p class="fiche-meta">ğŸ“ ' + region + ' | ğŸ“… ' + date + '</p>\n' +
'</div>\n' +
imageTag + '\n' +
'<div class="fiche-article">' + article + '</div>\n' +
'<div id="phase1">\n' +
'  <h2>ğŸ“š Phase 1 : Vocabulaire</h2>\n' +
'  <table class="fiche-table">\n' +
'    <thead><tr><th>NÃ©erlandais</th><th>DE/HET</th><th>FranÃ§ais</th><th>Exemple</th></tr></thead>\n' +
'    <tbody>\n' +
vocabRows_html + '\n' +
'    </tbody>\n' +
'  </table>\n' +
'  <h2>ğŸ”¤ Verbes</h2>\n' +
'  <table class="fiche-table">\n' +
'    <thead><tr><th>Verbe</th><th>Type</th><th>Forme</th><th>Sens</th><th>Exemple</th></tr></thead>\n' +
'    <tbody>\n' +
verbRows_html + '\n' +
'    </tbody>\n' +
'  </table>\n' +
'  <button onclick="goToQuiz()">â¡ï¸ Passer au quiz</button>\n' +
'</div>\n' +
'<div id="phase2" class="hidden">\n' +
'  <h2>âœï¸ Phase 2 : Quiz</h2>\n' +
'  <div class="progress-container">\n' +
'    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>\n' +
'    <div class="progress-text" id="progressText">Question 0 / 0</div>\n' +
'  </div>\n' +
'  <div id="quizZone"></div>\n' +
'</div>\n' +
'<script>\n' +
'function pronounce(word) {\n' +
'  if (!window.speechSynthesis) {\n' +
'    console.error("Web Speech API non disponible");\n' +
'    return;\n' +
'  }\n' +
'  \n' +
'  window.speechSynthesis.cancel();\n' +
'  \n' +
'  const utterance = new SpeechSynthesisUtterance(word);\n' +
'  utterance.lang = "nl-NL";\n' +
'  utterance.rate = 0.8;\n' +
'  utterance.volume = 1;\n' +
'  utterance.pitch = 1;\n' +
'  \n' +
'  utterance.onerror = (event) => {\n' +
'    console.error("Erreur prononciation:", event.error);\n' +
'  };\n' +
'  \n' +
'  window.speechSynthesis.speak(utterance);\n' +
'}\n' +
'const encouragements = [\n' +
'  "Goed bezig! ğŸ’ª",\n' +
'  "Je doet het prima! ğŸŒŸ",\n' +
'  "Fantastisch! ğŸ‰",\n' +
'  "Super werk! â­",\n' +
'  "Heel goed! ğŸš€",\n' +
'  "Geweldig! ğŸ†",\n' +
'  "Meesterlijk! ğŸ‘"\n' +
'];\n' +
'let questions = ' + questionsJSON + ';\n' +
'let indexQ = 0;\n' +
'function getRandomEncouragement() {\n' +
'  return encouragements[Math.floor(Math.random() * encouragements.length)];\n' +
'}\n' +
'function updateProgress() {\n' +
'  const percent = (indexQ / questions.length) * 100;\n' +
'  document.getElementById("progressFill").style.width = percent + "%";\n' +
'  document.getElementById("progressText").textContent = "Question " + indexQ + " / " + questions.length;\n' +
'}\n' +
'function goToQuiz() {\n' +
'  document.getElementById("phase1").classList.add("hidden");\n' +
'  document.getElementById("phase2").classList.remove("hidden");\n' +
'  afficherQuestion();\n' +
'}\n' +
'function afficherQuestion() {\n' +
'  const zone = document.getElementById("quizZone");\n' +
'  updateProgress();\n' +
'  if (indexQ >= questions.length) {\n' +
'    zone.innerHTML = \'<div class="completion-message"><p>âœ… Quiz terminÃ© ! Bravo !</p><p style="font-size: 1.1em; color: #c41e3a;">Goed gedaan! ğŸŠ</p><button class="btn btn-primary" onclick="location.reload()">ğŸ”„ Recommencer</button></div>\';\n' +
'    return;\n' +
'  }\n' +
'  zone.innerHTML = `\n' +
'    <p><strong>Question ${indexQ + 1} / ${questions.length}</strong></p>\n' +
'    <p style="font-size: 1.1em; margin: 15px 0;">${questions[indexQ].question}</p>\n' +
'    <button onclick="suivante()">â¡ï¸ Voir la rÃ©ponse</button>\n' +
'  `;\n' +
'}\n' +
'function suivante() {\n' +
'  const zone = document.getElementById("quizZone");\n' +
'  const reponseCorrecte = questions[indexQ].reponse;\n' +
'  zone.innerHTML += "<div class=\\"answer-display\\">âœ… RÃ©ponse : <strong>" + reponseCorrecte + "</strong></div>";\n' +
'  zone.innerHTML += "<div class=\\"encouragement\\">"+ getRandomEncouragement() + "</div>";\n' +
'  indexQ++;\n' +
'  setTimeout(() => afficherQuestion(), 2000);\n' +
'}\n' +
'<\/script>\n' +
'</div>\n' +
'</body>\n' +
'</html>\n';

  document.getElementById("output").value = htmlGenere;
  document.getElementById("btnTelecharger").style.display = "flex";
}

function telechargerFiche() {
  const region = document.getElementById("region").value.trim();
  const date = document.getElementById("date").value;
  
  if (!region || !date) {
    alert("Merci de remplir la rÃ©gion et la date pour le nom du fichier.");
    return;
  }

  const nomFichier = region + "_" + date + ".html";
  const blob = new Blob([htmlGenere], { type: "text/html;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = nomFichier;
  link.click();
  URL.revokeObjectURL(link.href);
  
  alert("Fiche tÃ©lÃ©chargÃ©e : " + nomFichier);
}

function pronounce(word) {
  const utterance = new SpeechSynthesisUtterance(word);
  utterance.lang = "nl-NL";
  utterance.rate = 0.8;
  window.speechSynthesis.speak(utterance);
}
</script>

</body>
</html>